---
title: 客户端死循环导致服务端请求十倍飙升记
category: 网站开发
feature_image: "https://ssevening.github.io/assets/android.png"
image: "https://ssevening.github.io/assets/android.png"
---

近期面临的挑战越来越多，稍微一个小的错误或问题就会被无限的放大，这不，昨天搞了个事情，就差点用自己客户端把自己的服务端给压垮。所以今天来讨论一下，晚天怎么产生的十倍压力飙升。


<!-- more -->

## 一、背景
昨天下午5点，服务端在客户端投了一个可以弹出的H5页面广告页面，然后就发现服务端首页相关的请求量大幅度飙升，紧急下线掉这个投放后恢复，那后面的工作就是我们来排查产生问题的原因了。

## 二、排查问题思路
* 排查问题前，首先要确认下面问题：
   * 什么东西变化了？ 【投放系统规则和投放H5页面，都有变化】
   * 哪些没有动？ 【客户端没有任何改动】
   * iPhone客户端和Android客户端表现一样吗？ 【只有Android出现飙升】
   * 然后再判断一个方向，一种可能性去细查。 【即新投放的页面和客户端可能出现循环的场景去推测排查】


* 首先我们要查出哪些设备的请求飙升：
   * 请求飙升，客户端的请求行为肯定会在服务端留下记录，通过服务端查询，获取请求较高的设备ID。
* 获取到设备ID后，给这个设备ID下发获取Log的指令，得到用户Log日志，从Log看出用户是从首页跳首页，再跳首页，再跳首页，无限循环下去。
* 现象知道以后，就去查看客户端代码逻辑，去逻列所有会跳转到首页代码入口如下：
   * 执行 hirbird 协议可以跳转的首页。【问服务端的结果是：未调用任何 Hirbird 协议】
   * 访问 http://www.xxx.com/ 的URL 会跳转到首页 【继续找H5页面人员沟通排查】
      * 投放URL只是一个入口，会根据UA判断设备，PC请求跳转到PC页，Mobile跳转到Mobile页面。
      * 继续追查，Mobile跳转正常，那PC跳转呢？因为Android的平板发送的UserAgent和PC是一样的，而我们的用户中，必然存在Android平板用户。
      * 然后去查平板的访问，结果真相大白，平板访问时，竟然跳转到了 http://www.xxx.com/， 而这个URL又会被客户端接手处理跳转到App的首页，App首页启动打开后，又会再请求H5广告页面，又再次拉出新的首页，然后一直Loop下去。

至此，问题产生的原因，真相大白。优化保证业务上线的前提下，配置好PC访问的H5页面后，再次投放广告，服务端未产生任何API飙升。

产生问题原因如下图：

![死循环原因手稿](https://ssevening.github.io/assets/loop/loop.jpg)

补充科普知识：

[UserAgent](https://developer.chrome.com/multidevice/user-agent)

[服务端设备识别](https://github.com/ahand/mobileesp/blob/master/Java/UAgentInfo.java)


## 三、如何解决再次出现类似的情况

最初的想法是：是URL配置错误，后面不要再配错，不就好了？但：靠人来保证的事情都是不靠谱的，人可以犯错误，但机器和代码不可以犯错误，如果死循环，自己的App把自己的服务端搞挂，就是大故障了。

那这样要解决的问题如下：

1. 首先要保证的是广告页面投放的正确性。
2. 再就是客户端一定要去除死循环产生。
   * 快速方案可以去掉 http://www.xxx.com/ 网址向 客户端首页的跳转逻辑。
   * 优化方案，增加防死循环跳转保护机制。
      * 针对广告页入口的流量进行打标
      * 所有打标URL流量，记录短时间内重复URL跳转次数，超过固定次数就不再执行跳转。
      * 有记录就要有清理，超过1分钟后，URL记数功能清零，App退出时，URL计数Map清零。
3. 服务端在突然接到同一设备的大量多次请求时，进行相应的 防御、请求过滤、对自己后端服务进行保护？

## 四、其他方案权衡和试探

1. 为什么我们不通过客户端修改UA的方式，把所有的平板UA，改为手机的UA，就再也没有类似的问题产生。【对应上图中的三角】
  * UA属于用户原始设备数据，属于规范类数据，用户原始设备数据不建议修改，如果有识别错，那就改为识别库，但不能篡改用户原始数据，因为规范的东西，多个服务端可以适用，但如果我们篡改，那就需要多个服务端适配，反而不够通用。

  
2. 为什么要经过一个分发页？客户端为什么不直接请求目标网址？
  * 因为分发页，除了跳转功能外，还涉及到一些通用cookie的写入，如果客户端直接访问，那客户端就要维护一份与服务端一样的跳转规则，而客户端长尾的原因，写死了规则，后期服务端一旦修改，将是灾难！
  

## 五、事件感悟

* 客户端开发，一定不要把自己局限在客户端的开发上，随着业务和团队的扩大，我们开发的每一个功能，放在单一视角，单一功能上来看，都是正确的，但当一套完整的链接走下来时，就会出这样那样的问题。所以可以把一套流程串起来，并可以发现和预知问题的人，发挥的价值更大。
* 客户端的页面，也要分三六九等，首页重中之重，涉及到的调用，要慎重，要考虑。

    


欢迎关注作者微信公众号，及时获得作者更新：

![微信公众号](https://ssevening.github.io/assets/weichat_qrcode.jpg)

另外还建立了小密圈：圈主 和 嘉宾 都就职于 阿里巴巴 的顶尖开发者，开发的app被Google 编辑推荐，对性能，架构，图片，MD设计都有研究和深入，欢迎大家加入，提升自己，一起进步，互相帮助交流！

![微信公众号](https://ssevening.github.io/assets/mi_qrcode.png)










